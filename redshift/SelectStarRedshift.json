{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Stack to enable integration SelectStar with Redshift",
    "Parameters": {
        "Cluster": {
            "Type": "String",
            "AllowedPattern": "[\\w-]+",
            "Description": "Also known as \"Cluster identifier\" by AWS."
        },
        "Db": {
            "Description": "Comma separated list of Redshift database to grant access for Select Star.",
            "Type": "CommaDelimitedList"
        },
        "DbUser": {
            "Type": "String",
            "Default": "awsuser",
            "Description": "Redshift user used to connection for provision access for Select Star. This user is used only by CloudFormation for the purposes of eg. creating a user account with minimal rights, including without access to data necessary for integration.",
            "AllowedPattern": ".+"
        },
        "ExternalId": {
            "Description": "The Select Star external ID to authenticate your AWS account. Do not change or share this.",
            "MinLength": "1",
            "Type": "String"
        },
        "IamPrincipal": {
            "Description": "The Select Star IAM principal which has permission to your AWS account. Do not change this.",
            "MinLength": "1",
            "Type": "String"
        },
        "ConfigureS3Logging": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "If true and S3 logging disabled then the Redshift cluster configuration can be changed to enable S3 logging. It is recommended to set the value \"true\"."
        },
        "ConfigureS3LoggingRestart": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "If true and logging changes made then the Redshift cluster can be restarted to apply changes. It is recommended to set the value \"true\"."
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Redshift configuration"
                    },
                    "Parameters": [
                        "Cluster",
                        "Db",
                        "DbUser"
                    ]
                },
                {
                    "Label": {
                        "default": "Provisioning"
                    },
                    "Parameters": [
                        "ConfigureS3Logging",
                        "ConfigureS3LoggingRestart"
                    ]
                },
                {
                    "Label": {
                        "default": "Read-only. Do not change this."
                    },
                    "Parameters": [
                        "ExternalId",
                        "IamPrincipal"
                    ]
                }
            ],
            "ParameterLabels": {
                "Cluster": {
                    "default": "Redshift cluster name"
                },
                "Db": {
                    "default": "Redshift databases"
                },
                "ConfigureS3Logging": {
                    "default": "Configure S3 logging (if disabled)"
                },
                "ConfigureS3LoggingRestart": {
                    "default": "Restart Cluster (if necessary to apply changes)"
                }
            }
        }
    },
    "Conditions": {
        "CreateS3Bucket": {
            "Fn::Equals": [
                {
                    "Ref": "ConfigureS3Logging"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "LoggingBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "CreateS3Bucket",
            "DeletionPolicy": "Retain",
            "Properties": {
                "AccessControl": "Private",
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                }
            }
        },
        "LoggingBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "CreateS3Bucket",
            "Properties": {
                "Bucket": {
                    "Ref": "LoggingBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Ref": "LoggingBucket"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Ref": "LoggingBucket"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ],
                            "Principal": {
                                "Service": "redshift.amazonaws.com"
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:GetBucketAcl"
                            ],
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceArn": {
                                        "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:cluster:${Cluster}"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CrossAccountRolePolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "redshift:ListSchemas",
                                "redshift:ListTables",
                                "redshift:ListDatabases",
                                "redshift:ExecuteQuery",
                                "redshift:FetchResults",
                                "redshift:DescribeClusters",
                                "redshift:CancelQuery",
                                "redshift:DescribeQuery",
                                "redshift:DescribeTable",
                                "redshift:ViewQueriesFromConsole"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:cluster:${Cluster}"
                            }
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "redshift:GetClusterCredentials"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:dbuser:${Cluster}/selectstar"
                            }
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "redshift:GetClusterCredentials"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "LambdaTransform",
                                    "result"
                                ]
                            }
                        },
                        {
                            "Sid": "DataAPIPermissions",
                            "Action": [
                                "redshift-data:ExecuteStatement",
                                "redshift-data:ListDatabases",
                                "redshift-data:ListSchemas",
                                "redshift-data:ListTables",
                                "redshift-data:DescribeTable"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:cluster:${Cluster}"
                            }
                        },
                        {
                            "Sid": "DataAPIIAMSessionPermissionsRestriction",
                            "Action": [
                                "redshift-data:GetStatementResult",
                                "redshift-data:CancelStatement",
                                "redshift-data:DescribeStatement",
                                "redshift-data:ListStatements"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        },
                        {
                            "Sid": "ListObjectsInBucket",
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetLifecycleConfiguration",
                                "s3:GetBucketTagging",
                                "s3:GetInventoryConfiguration",
                                "s3:GetObjectVersionTagging",
                                "s3:ListBucketVersions",
                                "s3:GetBucketLogging",
                                "s3:GetBucketPolicy",
                                "s3:GetBucketOwnershipControls",
                                "s3:GetBucketPublicAccessBlock",
                                "s3:GetBucketPolicyStatus",
                                "s3:ListBucketMultipartUploads",
                                "s3:GetBucketVersioning",
                                "s3:GetBucketAcl",
                                "s3:ListMultipartUploadParts",
                                "s3:GetObject",
                                "s3:GetBucketLocation",
                                "s3:GetObjectVersion"
                            ],
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Fn::GetAtt": [
                                                    "LambdaProvision",
                                                    "LoggingBucket"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:s3:::",
                                            {
                                                "Fn::GetAtt": [
                                                    "LambdaProvision",
                                                    "LoggingBucket"
                                                ]
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "PolicyName": "EnableSelectStar",
                "Roles": [
                    {
                        "Ref": "CrossAccountRole"
                    }
                ]
            }
        },
        "CrossAccountRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Ref": "IamPrincipal"
                                }
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Condition": {
                                "StringEquals": {
                                    "sts:ExternalId": {
                                        "Ref": "ExternalId"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "RedshiftAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "redshift:*",
                                        "redshift-data:*"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:dbuser:${Cluster}/${DbUser}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:dbname:${Cluster}/*"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:cluster:${Cluster}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:parametergroup:*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "redshift-data:DescribeStatement",
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:PassRole"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess"
                ]
            }
        },
        "LambdaProvisionFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Timeout": 300,
                "Code": {
                    "S3Bucket": "cf-templates-pp3cips1o7jf-us-east-2",
                    "S3Key": "redshift/deployment-package.zip"
                },
                "Handler": "provision.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.9",
                "TracingConfig": {
                    "Mode": "Active"
                }
            }
        },
        "LambdaProvision": {
            "Type": "Custom::LambdaProvision",
            "Version": "1.0",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "LambdaProvisionFunction",
                        "Arn"
                    ]
                },
                "RedshiftRole": {
                    "Fn::GetAtt": [
                        "CrossAccountRole",
                        "Arn"
                    ]
                },
                "Bucket": {
                    "Fn::If": [
                        "CreateS3Bucket",
                        {
                            "Ref": "LoggingBucket"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Cluster": {
                    "Ref": "Cluster"
                },
                "Db": {
                    "Ref": "Db"
                },
                "DbUser": {
                    "Ref": "DbUser"
                },
                "Region": {
                    "Fn::Sub": "${AWS::Region}"
                },
                "ConfigureS3Logging": {
                    "Ref": "ConfigureS3Logging"
                },
                "ConfigureS3LoggingRestart": {
                    "Ref": "ConfigureS3LoggingRestart"
                }
            }
        },
        "LambdaTransformFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Timeout": 300,
                "Code": {
                    "S3Bucket": "cf-templates-pp3cips1o7jf-us-east-2",
                    "S3Key": "redshift/deployment-package.zip"
                },
                "Handler": "transform.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.9",
                "TracingConfig": {
                    "Mode": "Active"
                }
            }
        },
        "LambdaTransform": {
            "Type": "Custom::LambdaTransform",
            "Version": "1.0",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "LambdaTransformFunction",
                        "Arn"
                    ]
                },
                "Items": {
                    "Ref": "Db"
                },
                "Prefix": {
                    "Fn::Sub": "arn:aws:redshift:${AWS::Region}:${AWS::AccountId}:dbname:${Cluster}/"
                }
            }
        }
    },
    "Outputs": {
        "RoleArn": {
            "Value": {
                "Fn::GetAtt": [
                    "CrossAccountRole",
                    "Arn"
                ]
            },
            "Description": "The ARN value of the Cross-Account Role with IAM read-only permissions. Add this ARN value to Select Star."
        },
        "LoggingBucket": {
            "Value": {
                "Fn::GetAtt": [
                    "LambdaProvision",
                    "LoggingBucket"
                ]
            },
            "Description": "The bucket name which stores Redshift logs."
        }
    }
}